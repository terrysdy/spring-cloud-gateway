# 疑问
## 自定义扩展
  - 协议转换
    - 实现 GlobalFilter [GlobalFilter](https://cloud.spring.io/spring-cloud-gateway/reference/html/#writing-custom-global-filters)
    - http -> dubbo
  - filter
    > 实现 AbstractGatewayFilterFactory [AbstractGatewayFilterFactory](https://cloud.spring.io/spring-cloud-gateway/reference/html/#writing-custom-gatewayfilter-factories)
    - 限流降级熔断，是否直接支持 sentinel
     > sentinel 官方适配包 [sentinel-adaptor](https://sentinelguard.io/zh-cn/docs/api-gateway-flow-control.html)
  - predicate
    > 实现 AbstractRoutePredicateFactory [AbstractRoutePredicateFactory](https://cloud.spring.io/spring-cloud-gateway/reference/html/#writing-custom-route-predicate-factories)
  - route 配置加载
    > 实现 RouteDefinitionLocator [RouteDefinitionLocator](https://cloud.spring.io/spring-cloud-gateway/reference/html/#configuration)
## 监控数据
  - 默认 metrics 怎么样的 
    > 自带的 metric filter [metrics filter](https://cloud.spring.io/spring-cloud-gateway/reference/html/#the-gateway-metrics-filter)
  - 如何自定义格式，自定义 collect
  
## 源码
### 概念
https://cloud.spring.io/spring-cloud-gateway/reference/html/#glossary
- Route. gateway 中最基本的概念。由 id、url(下游目标 Url)、一些 Predicate、一些 Filter 组成，可以理解成 gateway 接受到请求后可能执行的一个路径，gateway 中有很多 Route，请求过来根据 Route 中的 Predicate 判断该请求是否命中 Route 规则，然后再执行 Filter 链
- Predicate. 概含义念同 java 的 Predicate，gateway 用来判断一个请求是否匹配，实现为 AsyncPredicate 稍微包装了一下，入参是包含请求信息的 ServerWebExchange，响应为 Boolean
- Filter. GatewayFilter 在调用下游服务之前、之后可以修改请求、响应信息


### 流程
#### 启动时加载 Route 
![springcloud-gateway启动加载.png](quiver-image-url/F6D132AAC129A616BF018452B45C52BE.png =1657x367)

```plantuml
@startuml

spring -> RouteRefreshListener: ContextRefreshEvent
RouteRefreshListener -> CachingRouteLocator: RefreshRoutesEvent，刷新 Routes
CachingRouteLocator -> CompositeRouteLocator: getRoutes()
note left: CachingRouteLocator 为默认的 RouteLocator，是获取 Route 的入口
CompositeRouteLocator -> RouteDefinitionRouteLocator: getRoutes()
note left
CachingRouteLocator 依赖 CompositeRouteLocator，CompositeRouteLocator 依赖了其他所有 RouteLocator，从而依赖了所有其他 RouteLocator(组合模式)
最重要的 RouteLocator 为 RouteDefinitionLocator，根据 RouteDefinition 转换为 Route
end note
RouteDefinitionRouteLocator -> CompositeRouteDefinitionLocator: getRouteDefinitions()，获取所有 RouteDefinition
note left
同样使用组合模式，依赖 CompositeRouteDefinitionLocator 从而依赖了所有 RouteDefinitionLocator
其中 PropertiesRouteDefinitionLocator 就是根据 properties 解析 RouteDefinition
也可以自己实现 RouteDefinitionLocator，自定义加载 RouteDefinition
end note
RouteDefinitionRouteLocator -> RouteDefinitionRouteLocator: 解析 Predicate、Filter 链，RouteDefinition -> Route

@enduml
```
#### 调用流程
![springcloud-gateway调用流程.png](quiver-image-url/2672FA4921554467E74E842439A5E2EC.png =1772x573)
```plantuml
@startuml
SpringFlux -> DispatcherHandler: handle(ServerWebExchange exchange)
DispatcherHandler -> RoutePredicateHandlerMapping: getHandler(ServerWebExchange exchange)。获取目标 handler
RoutePredicateHandlerMapping -> RoutePredicateHandlerMapping: lookupRoute(ServerWebExchange exchange)。根据 exchange 过滤目标 Route
note left
1. 从 routeLocator（即CachingRouteLocator）获取所有 Route
2. concatMap 根据 Route 中的 Predicate 条件判断该请求是否命中规则
3. 响应第一个命中规则的 Route
end note
RoutePredicateHandlerMapping -> RoutePredicateHandlerMapping: 将目标 Route 放进 exchange 的 arribute 里
RoutePredicateHandlerMapping -> DispatcherHandler: 统一响应 FilteringWebHandler
DispatcherHandler -> DispatcherHandler: invokeHandler(ServerWebExchange exchange, Object handler)，执行 handler 逻辑
DispatcherHandler -> FilteringWebHandler: handle(ServerWebExchange exchange)
note left: 经 HadnlerAdapter 确定 handler 类型后调用
FilteringWebHandler -> FilteringWebHandler: globle filter + route 的 filter 组成 filter 链
note left: DefaultGatewayFilterChain，责任链模式
FilteringWebHandler -> DefaultGatewayFilterChain: filter(ServerWebExchange exchange)。执行 filter 链
note left
具体的 filter 在执行 chain.filter(exchange) 之前操作，为请求下游服务前的操作，例如修改请求信息等
chain.filter(exchange) 之后的 doOnSuccess、doOnError、doFinally 在请求下游服务后，做一些
https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories
一些重要的 Filter
NettyWriteResponseFilter: 根据 NettyRoutingFilter 设置的 connection，获取 netty 接收到的数据写 response body/响应流
GatewayMetricsFilter: 请求响应耗时记录
NettyRoutingFilter: http/https 协议支持，使用 reactor-netty 执行下游服务 http 调用。接收到响应后，在 atrribute 中设置 response 及 connection

end note
@enduml
```


